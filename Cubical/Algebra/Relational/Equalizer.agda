{-

Equalizer of functions f g : S X ??? T X such that f and g act on relation Algebra

-}
{-# OPTIONS --cubical --no-import-sorts --safe #-}
module Cubical.Algebra.Relational.Equalizer where

open import Cubical.Foundations.Prelude
open import Cubical.Foundations.HLevels
open import Cubical.Foundations.RelationalStructure
open import Cubical.Data.Sigma
open import Cubical.HITs.SetQuotients
open import Cubical.HITs.PropositionalTruncation as Trunc
open import Cubical.Relation.Binary.Base

private
  variable
    ??? ?????? ??????' ?????? ??????' : Level

EqualizerStructure : {S : Type ??? ??? Type ??????} {T : Type ??? ??? Type ??????}
  (f g : ??? X ??? S X ??? T X)
  ??? Type ??? ??? Type (???-max ?????? ??????)
EqualizerStructure {S = S} f g X = ??[ s ??? S X ] f X s ??? g X s

EqualizerRelStr : {S : Type ??? ??? Type ??????} {T : Type ??? ??? Type ??????}
  {f g : ??? X ??? S X ??? T X}
  ??? StrRel S ??????' ??? StrRel T ??????' ??? StrRel (EqualizerStructure f g) ??????'
EqualizerRelStr ????? ????? R (s , _) (s' , _) = ????? R s s'

equalizerSuitableRel : {S : Type ??? ??? Type ??????} {T : Type ??? ??? Type ??????}
  {f g : ??? X ??? S X ??? T X}
  {????? : StrRel S ??????'} {????? : StrRel T ??????'}
  (??f : ??? {X Y} {R : X ??? Y ??? Type ???} {s s'} ??? ????? R s s' ??? ????? R (f X s) (f Y s'))
  (??g : ??? {X Y} {R : X ??? Y ??? Type ???} {s s'} ??? ????? R s s' ??? ????? R (g X s) (g Y s'))
  ??? SuitableStrRel S ?????
  ??? SuitableStrRel T ?????
  ??? SuitableStrRel (EqualizerStructure f g) (EqualizerRelStr ????? ?????)
equalizerSuitableRel {f = f} {g} {?????} {?????} ??f ??g ????? ????? .quo (X , s , p) (R , qer) r =
  ( ((quo??? .fst .fst , sym step??? ??? step???) , quo??? .fst .snd)
  , ?? {((s' , _) , r') ???
    ?????Prop (?? _ ??? ????? .prop (?? _ _ ??? squash/ _ _) _ _)
      (?????Prop (?? _ ??? ????? .set squash/ _ _)
        (cong fst (quo??? .snd (s' , r'))))}
  )
  where
  quo??? = ????? .quo (X , s) (R , qer) r
  quo??? = ????? .quo (X , f X s) (R , qer) (??f r)

  step??? : quo??? .fst .fst ??? f (X / R .fst) (quo??? .fst .fst)
  step??? =
    cong fst
      (quo??? .snd
        (f _ (quo??? .fst .fst) , ??f (quo??? .fst .snd)))

  step??? : quo??? .fst .fst ??? g (X / R .fst) (quo??? .fst .fst)
  step??? =
    cong fst
      (quo??? .snd
        ( g _ (quo??? .fst .fst)
        , subst (?? t ??? ????? (graphRel [_]) t (g _ (quo??? .fst .fst))) (sym p) (??g (quo??? .fst .snd))
        ))
equalizerSuitableRel _ _ ????? _ .symmetric R = ????? .symmetric R
equalizerSuitableRel _ _ ????? _ .transitive R R' = ????? .transitive R R'
equalizerSuitableRel _ _ ????? ????? .set setX =
  isSet?? (????? .set setX) ?? _ ??? isOfHLevelPath 2 (????? .set setX) _ _
equalizerSuitableRel _ _ ????? _ .prop propR _ _ = ????? .prop propR _ _
